= Java SE 21 (JDK 21)
:toc:
:toclevels: 4

== Introduction

This document provides a structured overview of new features, enhancements, JVM parameter changes, garbage collector comparisons, and a feature timeline from JDK 11 to JDK 21.

== Feature Timeline: JDK 11 to JDK 21

This section summarizes the major features and enhancements introduced in each JDK release from 11 to 21.

[cols="1,4"]
|===
| Version | Key Features

| JDK 11
| - Local-Variable Syntax for Lambda Parameters (var)
  - HTTP Client (Standard)
  - Flight Recorder
  - ZGC (Experimental)
  - Epsilon GC (Experimental)
  - String methods: `isBlank`, `lines`, `strip`, `repeat`
  - Running single-file source-code programs
  - TLS 1.3 support

| JDK 12
| - Switch Expressions (Preview)
  - Shenandoah GC (Experimental)
  - JVM Constants API
  - Compact Number Formatting
  - Microbenchmark Suite

| JDK 13
| - Text Blocks (Preview)
  - Dynamic CDS Archives
  - Reimplement the Legacy Socket API
  - Switch Expressions (2nd Preview)

| JDK 14
| - Records (Preview)
  - Pattern Matching for instanceof (Preview)
  - Helpful NullPointerExceptions
  - NVM File Mapping
  - Foreign-Memory Access API (Incubator)
  - jpackage tool (Incubator)

| JDK 15
| - Sealed Classes (Preview)
  - Hidden Classes
  - ZGC and Shenandoah GC become production-ready
  - Text Blocks (Standard)
  - Edwards-Curve Digital Signature Algorithm (EdDSA)

| JDK 16
| - Records (Standard)
  - Pattern Matching for instanceof (Standard)
  - Unix-Domain Socket Channels
  - Strongly Encapsulate JDK Internals by Default
  - Foreign Linker API (Incubator)

| JDK 17 (LTS)
| - Sealed Classes (Standard)
  - Pattern Matching for switch (Preview)
  - New macOS Rendering Pipeline (Metal)
  - Strong encapsulation of internal APIs
  - Deprecate and remove older GCs (CMS)
  - Context-specific deserialization filters

| JDK 18
| - Simple Web Server
  - UTF-8 by Default
  - Code Snippets in Java API Documentation
  - Internet-Address Resolution SPI

| JDK 19
| - Virtual Threads (Preview, Project Loom)
  - Record Patterns (Preview)
  - Pattern Matching for switch (2nd Preview)
  - Foreign Function & Memory API (Preview)
  - Structured Concurrency (Incubator)

| JDK 20
| - Scoped Values (Incubator)
  - Record Patterns (2nd Preview)
  - Pattern Matching for switch (3rd Preview)
  - Foreign Function & Memory API (2nd Preview)
  - Virtual Threads (2nd Preview)

| JDK 21 (LTS)
| - Virtual Threads (Standard)
  - Record Patterns (Standard)
  - Pattern Matching for switch (Standard)
  - Sequenced Collections
  - String Templates (Preview)
  - Unnamed Patterns and Variables (Preview)
  - Generational ZGC
  - Key Encapsulation Mechanism API
  - Deprecate and remove older/experimental features

|===

== Major Features and Enhancements in JDK 21

=== Language Features

- **Pattern Matching for switch (Preview)**: Enhancements to the switch statement, allowing patterns to be used in case labels.
- **Record Patterns (Preview)**: Deconstructing records in a more concise way.
- **Sealed Interfaces and Classes**: More flexible sealed classes and interfaces.
- **String Templates (Preview)**: A new way to define and use string literals with embedded expressions.
- **Unnamed Patterns and Variables (Preview)**: Allowing patterns and variables without explicit names in certain contexts.

=== API Enhancements

- **Sequenced Collections**: Introduced in JDK 21, the `SequencedCollection`, `SequencedSet`, and `SequencedMap` interfaces provide a uniform way to work with collections that have a defined encounter order. They add methods for accessing, inserting, and removing elements at the beginning and end of collections, making it easier to write code that works with both lists and deques, as well as ordered sets and maps. This unifies and simplifies collection manipulation where order matters.
- **Foreign Function & Memory API (Incubator)**: A new API to interact with code and data outside of the JVM.
- **Structured Concurrency (Incubator)**: A new concurrency model to simplify multithreading.
- **Key Encapsulation Mechanism API**: A new API for key encapsulation mechanisms, enhancing security features.
- **New macOS Rendering Pipeline**: A new rendering pipeline for macOS, based on Appleâ€™s Metal framework.

=== Concurrency Enhancements

- **Virtual Threads**: JDK 21 introduces virtual threads as a standard feature (Project Loom). Virtual threads are lightweight threads managed by the JVM, allowing you to create millions of concurrent threads with minimal resource overhead. They are ideal for high-throughput, concurrent applications such as servers and reactive systems. Virtual threads use the same `java.lang.Thread` API, making it easy to adopt them in existing code. They dramatically simplify writing scalable, blocking code without the complexity of asynchronous programming models.

==== Virtual Threads Details

- **What are Virtual Threads?**
  Virtual threads are threads that are scheduled by the Java runtime rather than the operating system. They are much lighter than platform (OS) threads, enabling the JVM to handle many more concurrent tasks.

- **Benefits:**
  * Enable massive concurrency (millions of threads).
  * Reduce the need for thread pools and complex asynchronous code.
  * Use the familiar `Thread` API and work seamlessly with existing synchronization primitives.
  * Improve scalability for I/O-bound and high-concurrency applications.

- **Usage Example:**
  ```java
  try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
      executor.submit(() -> {
          // Task code here
      });
  }
  // Or simply:
  Thread.startVirtualThread(() -> {
      // Task code here
  });
  ```

- **When to Use:**
  * Server applications handling many simultaneous connections (e.g., HTTP servers).
  * Applications with many blocking operations (I/O, database calls).
  * Migrating from callback-based async code to simpler, blocking code.

For more details, see:
https://openjdk.org/jeps/444

==== Sequenced Collections Details

- **What are Sequenced Collections?**
  Sequenced collections are a new set of interfaces in the Java Collections Framework that define a consistent API for collections with a defined order (encounter order).

- **Key Interfaces:**
  * `SequencedCollection<E>`
  * `SequencedSet<E>`
  * `SequencedMap<K,V>`

- **Key Methods:**
  * `getFirst()`, `getLast()`
  * `addFirst(E)`, `addLast(E)`
  * `removeFirst()`, `removeLast()`
  * `reversed()`

- **Benefits:**
  * Unified way to manipulate the "ends" of lists, sets, and maps.
  * Simplifies code that needs to work with both lists and deques, or with ordered sets/maps.
  * Makes encounter order manipulation explicit and consistent.

- **Usage Example:**
  ```java
  SequencedCollection<String> sc = new ArrayList<>();
  sc.addFirst("first");
  sc.addLast("last");
  String first = sc.getFirst();
  String last = sc.getLast();
  ```

For more details, see:
https://openjdk.org/jeps/431

== JVM Parameter Changes and Enhancements

This section highlights key changes, enhancements, and removals in JVM parameters (options) between JDK 11 and JDK 21.

=== Removed and Deprecated JVM Options

- Several options deprecated in JDK 11 have been removed in JDK 21.
- Examples:
  * `-XX:+UseConcMarkSweepGC` (CMS GC) is removed in JDK 21. Use G1GC or other collectors.
  * `-XX:+UseParNewGC` is removed.
  * `-XX:+UseAdaptiveGCBoundary` is removed.
  * `-XX:+AggressiveOpts` is removed.
- Deprecated options in JDK 21 are marked with warnings at startup.

=== New and Enhanced JVM Options in JDK 21

==== Garbage Collection

- ZGC (`-XX:+UseZGC`) and Shenandoah (`-XX:+UseShenandoahGC`) are production-ready in JDK 21.
- New options for tuning ZGC and Shenandoah, e.g., `-XX:ZGenerational`, `-XX:ShenandoahGCHeuristics`, `-XX:MaxGCPauseMillis`.
- Default GC is G1GC (improved in JDK 21).

==== Memory Management

- `-XX:SoftMaxHeapSize` (soft upper bound for heap).
- `-XX:MaxRAMPercentage`.
- Improved container awareness (`-XX:+UseContainerSupport`).

==== Logging and Diagnostics

- Enhanced unified logging (`-Xlog`).
- Diagnostic options (`-XX:+UnlockDiagnosticVMOptions`).
- Java Flight Recorder (`-XX:+FlightRecorder`, `-XX:StartFlightRecording`).

==== Security

- TLS and named group options.

==== Preview and Incubator Features

- `--enable-preview`.
- Project Loom options (`-Djdk.virtualThreadScheduler.parallelism`).

=== Example JVM Parameter Usage

```
java --enable-preview -XX:+UseZGC -XX:ZGenerational -XX:SoftMaxHeapSize=2g -Djdk.virtualThreadScheduler.parallelism=8 -XX:+FlightRecorder -Xlog:gc*:file=gc.log:time
```

== Garbage Collector Comparison: G1GC, ZGC, and Shenandoah

[cols="1,1,1,1,2"]
|===
| Feature | G1GC | ZGC | Shenandoah | Notes

| Availability
| Default (JDK 9+) | Production (JDK 15+) | Production (JDK 17+)
| G1GC is default; ZGC and Shenandoah must be enabled explicitly.

| Pause Time Goal
| Low-pause (tunable, ~10-200ms) | Very low-pause (<10ms, target) | Very low-pause (<10ms, target)
| ZGC and Shenandoah are designed for ultra-low pause times.

| Heap Size Support
| Small to large heaps (few GBs to ~multi-TB) | Very large heaps (multi-TB) | Large heaps (multi-TB)
| ZGC and Shenandoah scale better for huge heaps.

| Compaction
| Concurrent (region-based) | Concurrent | Concurrent
| All perform concurrent compaction to minimize pauses.

| Relocation/Moving Objects
| Mostly concurrent | Fully concurrent | Fully concurrent
| ZGC and Shenandoah move objects with minimal stop-the-world pauses.

| Supported Platforms
| All major platforms | Linux, Windows, macOS | Linux, Windows (limited macOS support)
| ZGC and Shenandoah have more limited platform support.

| Overhead
| Moderate | Low | Low
| ZGC and Shenandoah aim for minimal application impact.

| Use Cases
| General purpose, default for most | Large heaps, low-latency apps, cloud | Low-latency, large heaps, cloud, JVM-based services
| Choose based on latency and heap requirements.

| How to Enable
| `-XX:+UseG1GC` (default) | `-XX:+UseZGC` | `-XX:+UseShenandoahGC`
|

|===

**Summary:**
- G1GC is the default collector, suitable for most workloads with moderate pause time requirements.
- ZGC and Shenandoah are designed for applications needing ultra-low pause times and very large heaps, such as big data, real-time analytics, and cloud-native services.
- ZGC and Shenandoah perform most GC work concurrently, minimizing application pauses even as heap sizes grow.


== Advanced JVM Tuning for High-Performance Microservices on Linux

=== Performance-Oriented JVM Parameters

- `-XX:+UseNUMA`: Enables NUMA-aware memory allocation for multi-socket systems.
- `-XX:+AlwaysPreTouch`: Pre-touches memory pages to reduce page faults at runtime.
- `-XX:+UseLargePages`: Enables large memory pages for reduced TLB misses.
- `-XX:ThreadStackSize=<size>`: Adjusts thread stack size for optimal memory usage.
- `-XX:+DisableExplicitGC`: Prevents explicit GC calls from causing full GC pauses.
- `-XX:+OptimizeStringConcat`: Enables string concatenation optimizations.
- `-XX:+UseFastJNIAccessors`: Optimizes JNI calls for better native performance.

=== Linux-Specific Tuning

- `-XX:+UseTransparentHugePages`: Leverages Linux transparent huge pages for heap.
- `-XX:ActiveProcessorCount=<count>`: Explicitly sets the number of CPUs JVM should use.
- `-XX:+UseContainerSupport`: Ensures JVM respects container CPU/memory limits.

=== Microservice-Oriented Features

- **Structured Concurrency (JEP 453)**: Simplifies concurrent task management.
- **Foreign Function & Memory API (JEP 428)**: Efficient native interop for high-performance needs.
- **Generational ZGC (JEP 439)**: Improved GC for microservices with short-lived objects.

=== Monitoring and Observability

- Java Flight Recorder
- Resource Management options

=== Security and Networking

- TLS protocol enforcement
- HTTP server connection limits

=== Example JVM Startup for Microservices

```
java --enable-preview -XX:+UseZGC -XX:ZGenerational -XX:+UseNUMA -XX:+AlwaysPreTouch -XX:+UseLargePages -XX:ThreadStackSize=512 -XX:+FlightRecorder -Xlog:gc*:file=gc.log:time
```

== Behavioral Changes

- Default GC improvements
- Container resource detection
- Stricter JVM argument validation

== References

- Full list of JVM options: https://docs.oracle.com/en/java/javase/21/docs/specs/man/java.html
- JEPs for new features: https://openjdk.org/projects/jdk/21/
- JDK 11 JVM Options: https://docs.oracle.com/en/java/javase/11/docs/specs/man/java.html
- JEPs affecting JVM options: https://openjdk.org/jeps/0
