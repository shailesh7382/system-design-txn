= Liquibase Database Migration Example (SQL Changelogs, Java Runner, Maven)

A sample project demonstrating robust database schema migrations using Liquibase with SQL changelogs, Maven, and a custom Java runner. Supports H2, ClickHouse, and Oracle out-of-the-box.

== Features

- **Liquibase** for versioned, repeatable database migrations
- **SQL-formatted changelogs** for easy review and editing
- **Custom Java runner** for flexible CLI-based migration/rollback/status
- **Maven integration** for build-time migrations
- **Multi-database support** (H2, ClickHouse, Oracle)
- **Sample shell scripts** for automation

== Project Structure

- `pom.xml` — Maven build and dependency configuration
- `src/main/java/com/example/liquibasecheck/LiquibaseRunner.java` — Java CLI runner for migrations
- `src/main/resources/db/changelog/`
  * `db.changelog-master.sql` — Master changelog (includes all others)
  * `db.changelog-1.0.sql` — Initial schema (person table)
  * `db.changelog-2.0.sql` — Example schema update (add age column)
- `src/main/resources/logback.xml` — Logging configuration
- `run-liquibase-java.sh` — Shell script to run the Java CLI runner

== Usage

=== 1. Build the Project

[source,shell]
----
mvn clean package
----

This creates a fat JAR at `target/liquibase-check-1.0-SNAPSHOT-shaded.jar`.

=== 2. Run Migrations

==== a. Using the Java CLI Runner

Run migrations, rollback, or status checks using the provided shell script:

[source,shell]
----
./run-liquibase-java.sh update
----

You can specify database type and connection details (defaults to H2):

[source,shell]
----
./run-liquibase-java.sh update clickhouse "jdbc:clickhouse://localhost:8123/default" default "" "db/changelog/db.changelog-master.sql"
----

Rollback by tag or count:

[source,shell]
----
./run-liquibase-java.sh rollback h2 "" "" "" "" v1.0
./run-liquibase-java.sh rollback h2 "" "" "" "" 1
----

Show pending changesets:

[source,shell]
----
./run-liquibase-java.sh status
----

==== b. Using Maven (H2 only, by default)

[source,shell]
----
mvn liquibase:update
----

==== c. Using Liquibase CLI

[source,shell]
----
liquibase \
  --changeLogFile=src/main/resources/db/changelog/db.changelog-master.sql \
  --url="jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1" \
  --username=sa \
  --password= \
  --driver=org.h2.Driver \
  update
----

== Configuration

You can override database connection and changelog file via CLI arguments or environment variables:

- `DB_TYPE` (h2, clickhouse, oracle)
- `DB_URL`
- `DB_USER`
- `DB_PASS`
- `CHANGELOG`

Order of precedence: CLI args > environment variables > defaults.

== Migration Workflow

. Create a new SQL changelog in `src/main/resources/db/changelog/` (e.g., `db.changelog-3.0.sql`)
. Write your migration using Liquibase SQL format:
+
[source,sql]
----
--liquibase formatted sql

-- changeset yourname:unique-id
ALTER TABLE person ADD COLUMN email VARCHAR(255);
----
. Add an `--include` line for your new changelog in `db.changelog-master.sql`
. Run migrations as above

== Example Changelogs (Exhaustive SQL for H2, Oracle, ClickHouse)

=== Version 1.0: Create `person` Table

[source,sql]
----
--liquibase formatted sql

-- changeset dev:1.0-create-person-table

-- H2
--comment: Create person table for H2
--precondition-sql-check expectedResult:0
SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'PERSON';
CREATE TABLE person (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255)
);

-- Oracle
--comment: Create person table for Oracle
--precondition-dbms type:oracle
--precondition-sql-check expectedResult:0
SELECT COUNT(*) FROM user_tables WHERE table_name = 'PERSON';
CREATE TABLE person (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(255)
);

-- ClickHouse
--comment: Create person table for ClickHouse
--precondition-dbms type:clickhouse
--precondition-sql-check expectedResult:0
SELECT count() FROM system.tables WHERE name = 'person';
CREATE TABLE person (
    id UInt32,
    name String
) ENGINE = MergeTree()
ORDER BY id;
----

=== Version 2.0: Add `age` Column to `person`

[source,sql]
----
--liquibase formatted sql

-- changeset dev:2.0-add-age-to-person

-- H2
--comment: Add age column for H2
--precondition-dbms type:h2
ALTER TABLE person ADD COLUMN age INT;

-- Oracle
--comment: Add age column for Oracle
--precondition-dbms type:oracle
ALTER TABLE person ADD (age NUMBER);

-- ClickHouse
--comment: Add age column for ClickHouse
--precondition-dbms type:clickhouse
ALTER TABLE person ADD COLUMN age UInt32;
----

== Best Practices

- Use unique, descriptive changeset IDs
- Keep changesets atomic (one logical change per changeset)
- Always update the master changelog in order
- Test migrations locally before production

== References

- https://www.liquibase.org/documentation/index.html
- https://www.liquibase.org/documentation/format_sql.html
- https://github.com/liquibase/liquibase
